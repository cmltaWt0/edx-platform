<%! from django_comment_client.helpers import url_for_tags, url_for_user %>
<%! from datehelper import time_ago_in_words %>
<%! from dateutil.parser import parse %>
<%! from django_comment_client.helpers import close_thread_text, \
                                              url_for_tags, \
                                              url_for_user, \
                                              pluralize
%>

<div class="discussion-content">
  <div class="discussion-content-wrapper">
    ${render_vote(content)}
    <div class="discussion-right-wrapper">
      <ul class="admin-actions">
        % if content['type'] == 'comment':
          <li><a href="javascript:void(0)" class="admin-endorse">Endorse</a></li>
        % endif
        <li><a href="javascript:void(0)" class="admin-edit">Edit</a></li>
        <li><a href="javascript:void(0)" class="admin-delete">Delete</a></li>
        % if content['type'] == "thread":
          <li><a class="discussion-openclose" id="discussion-openclose-${content['id']}" href="javascript:void(0);">${close_thread_text(content)}</a></li>
        % endif
      </ul>
      % if content['type'] == "thread":
        ${render_title(content)}
      % endif
      <div class="discussion-content-view">
        <a name="${content['id']}" style="width: 0; height: 0; padding: 0; border: none;"></a>
        <div class="content-body ${content['type']}-body" id="content-body-${content['id']}">${(content.get('highlighted_body') or content['body']) | h}</div>
        <div class="content-raw-body ${content['type']}-raw-body" style="display: none">${content['body'] | h}</div>
        % if content['type'] == "thread":
          ${render_tags(content)}
        % endif
        ${render_bottom_bar(content)}
      </div>
    </div>
  </div>
</div>

<%def name="render_title(content)">
  <a class="thread-title" name="${content['id']}" href="javascript:void(0)">${(content.get('highlighted_title') or content['title']) | h}</a>
  <div class="thread-raw-title" style="display: none">${content['title']}</div>
</%def>

<%def name="render_tags(content)">
  <div class="thread-tags">
    % for tag in content['tags']:
      <a class="thread-tag" href="${url_for_tags(content['course_id'], [tag])}">${tag | h}</a>
    % endfor
  </div>
  <div class="thread-raw-tags" style="display: none">${",".join(content['tags']) | h}</div>
</%def>

<%def name="render_bottom_bar(content)">
  <div class="info">
    ${render_info(content)}
    <ul class="discussion-actions">
      <li>${render_link("discussion-link discussion-reply discussion-reply-" + content['type'], "Reply")}</li>
      <li><div class="follow-wrapper"></div></li>
      <li>${render_link("discussion-link discussion-permanent-link", "Permanent Link")}</li>
    </ul>
  </div>
</%def>

<%def name="render_info(content)">
  
  <div class="comment-time">
    ${time_ago_in_words(parse(content['updated_at']))} ago by
    % if content['anonymous']:
      anonymous
    % else:
      <a href="${url_for_user(content['course_id'], content['user_id'])}">${content['username']}</a>
    % endif
  </div>
  <div class="comment-count">
    % if content.get('comments_count', -1) >= 0:
      % if discussion_type == 'user':
        <a href="javascript:void(0)" class="discussion-show-comments first-time">Show all comments (${content['comments_count']} total)</a>
      % else:
        <a href="javascript:void(0)" class="discussion-show-comments">Show ${content['comments_count']} ${pluralize('comment', content['comments_count'])}</a>
      % endif
    % endif
  </div>
</%def>

<%def name="render_link(cls, html)">
  <a class="${cls}" href="javascript:void(0)">${html}</a>
</%def>

<%def name="render_vote(content)">
  <div class="discussion-votes">
    ${render_link("discussion-vote discussion-vote-up", "&#9650;")}
    <div class="discussion-votes-point">${content['votes']['point']}</div>
    ${render_link("discussion-vote discussion-vote-down", "&#9660;")}
  </div>
</%def>
