<%! from django.utils.translation import ugettext as _ %>
<%! from django.core.urlresolvers import reverse %>
<%inherit file="../main.html" />

<%block name="bodyclass">register verification-process step-photos</%block>

<%block name="js_extra">
<!-- please move link to js/vendor/responsive-carousel/responsive-carousel.js from main.html to here -->
<script type="text/javascript">

  var onVideoFail = function(e) {
    console.log('Failed to get camera access!', e);
  };

  function initVideoCapture() {
    window.URL = window.URL || window.webkitURL;
    navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia || navigator.msGetUserMedia;
  }

  var submitToPaymentProcessing = function() {
    var xhr = $.post(
      "create_order",
      {
        "course_id" : "${course_id}"
      },
      function(data) {
        for (prop in data) {
          $('<input>').attr({
              type: 'hidden',
              name: prop,
              value: data[prop]
          }).appendTo('#pay_form');
        }
      }
    )
    .done(function(data) {
      $("#pay_form").submit();
    })
    .fail(function() { alert("error"); });
  }

  function initSnapshotHandler(name) {
    var video = $('#' + name + '_video');
    var canvas = $('#' + name + '_canvas');
    var image = $('#' + name + "_image");
    var captureButton = $("#" + name + "_capture_button");
    var resetButton = $("#" + name + "_reset_button");
    var approveButton = $("#" + name + "_approve_button");
    var nextButton = $("#" + name + "_next_button");

    var ctx = canvas[0].getContext('2d');
    var localMediaStream = null;

    function snapshot() {
      if (localMediaStream) {
        ctx.drawImage(video[0], 0, 0);
        image[0].src = canvas[0].toDataURL('image/png');
      }
      video[0].pause();

      captureButton.hide();
      resetButton.show();
      approveButton.show();
      return false;
    }

    function reset() {
      $('#face_image')[0].src = "";
      video[0].play();

      approveButton.removeClass('approved');
      nextButton.addClass('disabled');

      captureButton.show();
//      captureButton.removeClass('is-hidden');
      resetButton.hide();
//      resetButton.addClass('is-hidden');
      approveButton.hide();
//      approveButton.addClass('is-hidden');

      return false;
    }

    function approve() {
      approveButton.addClass('approved');
      nextButton.removeClass('disabled');

      return false;
    }

    // Initialize state for this picture taker
    captureButton.show();
    //captureButton.removeClass('is-hidden');

    resetButton.hide();
    //resetButton.addClass('is-hidden');

    approveButton.hide();
    //approveButton.addClass('is-hidden');

    nextButton.addClass('disabled');

    // Connect event handlers...
    video.click(snapshot);
    captureButton.click(snapshot);
    resetButton.click(reset);
    approveButton.click(approve);

    navigator.getUserMedia({video: true}, function(stream) {
      video[0].src = window.URL.createObjectURL(stream);
      localMediaStream = stream;
    }, onVideoFail);
  }

  function initPhotoBlocks() {
    // Photo wrapping
/*    $('.block-photo .control-redo').addClass('is-hidden');
    $('.block-photo .control-approve').addClass('is-hidden');
    $('.block-photo .m-btn-primary').addClass('disabled');
    $( "#wrapper-facephoto .control-do" ).click(function(e) {
        e.preventDefault();
        $(this).toggleClass('is-hidden');
        $('#wrapper-facephoto .control-redo').toggleClass('is-shown');
        $('#wrapper-facephoto .control-approve').toggleClass('is-shown');
    });
    $( "#wrapper-facephoto .control-approve" ).click(function(e) {
        e.preventDefault();
        $(this).addClass('approved');
        $('#wrapper-facephoto .m-btn-primary').removeClass('disabled');
    });
    $( "#wrapper-idphoto .control-do" ).click(function(e) {
        e.preventDefault();
        $(this).toggleClass('is-hidden');
        $('#wrapper-idphoto .control-redo').toggleClass('is-shown');
        $('#wrapper-idphoto .control-approve').toggleClass('is-shown');
    });
    $( "#wrapper-idphoto .control-approve" ).click(function(e) {
        e.preventDefault();
        $(this).addClass('approved');
        $('#wrapper-idphoto .m-btn-primary').removeClass('disabled');
    }); */
  }

  $(document).ready(function() {
    $(".carousel-nav").addClass('sr');
    $("#pay_button").click(submitToPaymentProcessing);
    $("#confirm_pics_good").click(function() {
      if (this.checked) {
        $("#pay_button_frame").removeClass('disabled');
      }
    });

    $("#pay_button_frame").addClass('disabled');

    initPhotoBlocks();
    initVideoCapture();
    initSnapshotHandler("face");
    initSnapshotHandler("photo_id");

  });
</script>
</%block>

<%block name="content">
<div class="container">
  <section class="wrapper">

    <header class="page-header">
      <h2 class="title">
        <span class="status-track">(ID Verified)</span>
        <span class="status">You are registering for</span>
        <span class="status-course">${course_id} </span>
      </h2>
    </header>

    <div class="wrapper-progress">
      <section class="progress">
        <h3 class="sr title">Your Progress</h3>

        <span class="progress-status">
          <span class="progress-status-value"></span>
        </span>

        <ol class="progress-steps">
          <li class="progress-step is-completed" id="progress-step0">
            <span class="step-number">0</span>
            <span class="step-name">Intro</span>
          </li>

          <li class="progress-step" id="progress-step1">
            <span class="step-number">1</span>
            <span class="step-name"><span class="sr">Current Step: </span>Take Photo</span>
          </li>

          <li class="progress-step" id="progress-step2">
            <span class="step-number">2</span>
            <span class="step-name">Intro</span>
          </li>

          <li class="progress-step" id="progress-step3">
            <span class="step-number">3</span>
            <span class="step-name">Intro</span>
          </li>

          <li class="progress-step" id="progress-step4">
            <span class="step-number">4</span>
            <span class="step-name">Intro</span>
          </li>

          <li class="progress-step" id="progress-step5">
            <span class="step-number">5</span>
            <span class="step-name">Confirmation</span>
          </li>
        </ol>
      </section>
    </div>

    <div class="wrapper-content-main">
      <article class="content-main">

        <section class="wrapper carousel"  data-transition="slide">
          <div id="wrapper-view wrapper-facephoto" class="block-photo">
            <div class="facephoto view">
              <h3 class="title">Take Your Photo</h3>
              <div class="instruction">
                <p>Use your webcam to take a picture of your face so we can match it with the picture on your ID.</p>
              </div>

              <div class="wrapper-task">
                <div id="facecam" class="task cam">
                  <div class="placeholder-cam">
                    <video id="face_video" width="400" height="300" autoplay></video><br/>
                    <canvas id="face_canvas" style="display:none;" width="640" height="480"></canvas>
                  </div>

                  <div class="controls photo-controls">
                    <ul class="list-controls">
                      <li class="control control-redo" id="face_reset_button">
                        <a class="action action-redo" href="">
                          <i class="icon-undo"></i> <span class="sr">Retake</span>
                        </a>
                      </li>

                      <li class="control control-do" id="face_capture_button">
                        <a class="action action-do" href="">
                          <i class="icon-camera"></i><span class="sr">Take photo</span>
                        </a>
                      </li>

                      <li class="control control-approve" id="face_approve_button">
                        <a class="action action-approve" href="">
                          <i class="icon-ok"></i> <span class="sr">Looks good</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="wrapper-help">
                  <div class="help-task photo-tips facetips">
                    <h4 class="title">Tips on taking a successful photo</h4>

                    <div class="copy">
                      <ul>
                        <li>Make sure your face is well-lit</li>
                        <li>Be sure your entire face is inside the frame</li>
                        <li>Can we match the photo you took with the one on your ID?</li>
                        <li>Click the checkmark once you are happy with the photo</li>
                      </ul>
                    </div>
                  </div>

                  <div class="help-faq facefaq">
                    <h4 class="sr title">Common Questions</h4>

                    <div class="copy">
                      <dl class="list-faq">
                        <dt class="faq-question">Why do you need my photo?</dt>
                        <dd class="faq-answer">We need your photo to confirm that you are you.</dd>

                        <dt class="faq-question">What do you do with this picture?</dt>
                        <dd class="faq-answer">We only use it to verify your identity.  It is not displayed anywhere.</dd>
                      </dl>
                    </div>
                  </div>
                </div>
              </div>

              <nav class="nav-wizard">
                <span class="help help-inline">Once you verify your photo looks good, you can move on to step 2.</span>

                <ol class="wizard-steps">
                  <li class="wizard-step">
                    <a class="next" id="face_next_button" href="#next" aria-hidden="true" title="Next">Go to Step 2: Take ID Photo</a>
                  </li>
                </ol>
              </nav>

            </div> <!-- /view -->
          </div> <!-- /wrapper-view -->

          <div id="wrapper-view wrapper-idphoto" class="block-photo">
            <div class="idphoto view">
              <h3 class="title">Show Us Your ID</h3>
              <div class="instruction">
                <p>Use your webcam to take a picture of your face so we can match it with the picture on your ID.</p>
              </div>

              <div class="wrapper-task">
                <div id="idcam" class="task cam">
                  <div class="placeholder-cam">
                    <video id="photo_id_video" width="400" height="300" autoplay></video><br/>
                    <canvas id="photo_id_canvas" style="display:none;" width="640" height="480"></canvas>
                  </div>

                  <div class="controls photo-controls">
                    <ul class="list-controls">
                      <li class="control control-redo" id="photo_id_reset_button">
                        <a class="action action-redo" href="">
                          <i class="icon-undo"></i> <span class="sr">Retake</span>
                        </a>
                      </li>

                      <li class="control control-do" id="photo_id_capture_button">
                        <a class="action action-do" href="">
                          <i class="icon-camera"></i> <span class="sr">Take photo</span>
                        </a>
                      </li>

                      <li class="control control-approve" id="photo_id_approve_button">
                        <a class="action action-approve" href="">
                          <i class="icon-ok"></i> <span class="sr">Looks good</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="wrapper-help">
                  <div class="help-task photo-tips facetips">
                    <h4 class="title">Tips on taking a successful photo</h4>

                    <div class="copy">
                      <ul>
                        <li>Make sure your ID is well-lit</li>
                        <li>Check that there isn't any glare</li>
                        <li>Ensure that you can see your photo and read your name</li>
                        <li>Try to keep your fingers at the edge to avoid covering important information</li>
                      </ul>
                    </div>
                  </div>

                  <div class="help-faq facefaq">
                    <h4 class="sr title">Common Questions</h4>

                    <div class="copy">
                      <dl class="list-faq">
                        <dt class="faq-question">Why do you need a photo of my ID?</dt>
                        <dd class="faq-answer">We need to match your ID with your photo and name to confirm that you are you.</dd>

                        <dt class="faq-question">What do you do with this picture?</dt>
                        <dd class="faq-answer">We encrypt it and send it to our secure authorization service for review. We use the highest levels of security and do not save the photo or information anywhere once the match has been completed.</dd>
                      </dl>
                    </div>
                  </div>
                </div>
              </div>

              <nav class="nav-wizard">
                <span class="help help-inline">Once you verify your ID photo looks good, you can move on to step 3.</span>

                <ol class="wizard-steps">
                  <li class="wizard-step">
                    <a class="next" id="photo_id_next_button" href="#next" aria-hidden="true" title="Next">Go to Step 3: Review Your Info</a>
                  </li>
                </ol>
              </nav>
            </div> <!-- /view -->
          </div> <!-- /wrapper-view -->

          <div id="wrapper-view wrapper-review">
            <div class="review view">
              <h3 class="title">Verify Your Submission</h3>
              <div class="instruction">
                <p>Make sure we can verify your identity with the photos and information below.</p>
              </div>

              <div class="wrapper-task">
                <ol class="review-tasks">
                  <li class="review-task">
                    <h4 class="title">Check Your Name</h4>

                    <div class="copy">
                      <p>Make sure your full name on your edX account, [User Name], matches your ID. We will also use this as the name on your certificate.</p>
                    </div>

                    <ul class="actions">
                      <li class="action action-editname">
                        <a rel="modal" class="edit-name" href="#">Edit my name</a>
                      </li>
                    </ul>
                  </li>

                  <li class="review-task">
                    <h4 class="title">Review the Photos You've Taken</h4>

                    <div class="copy">
                      <p>Make sure your full name on your edX account, [User Name], matches your ID. We will also use this as the name on your certificate.</p>
                    </div>

                    <ol class="wrapper-photos">
                      <li class="wrapper-photo">
                        <div class="placeholder-photo">
                          <img id="face_image" width="512" height="384" src=""/>
                        </div>

                        <div class="help-tips">
                          <h5>The photo above needs to meet the following requirements:</h5>
                          <ul class="list-tips">
                            <li class="tip">Be well lit</li>
                            <li class="tip">Show your whole face</li>
                            <li class="tip">Match your ID</li>
                          </ul>
                        </div>
                      </li>

                      <li class="wrapper-photo">
                       <div class="placeholder-photo">
                         <img id="photo_id_image" width="512" height="384" src=""/>
                       </div>

                       <div class="help-tips">
                         <h5>The photo above needs to meet the following requirements:</h5>
                         <ul class="list-tips">
                           <li class="tip">Be readable (not too far away, no glare)</li>
                           <li class="tip">Show your name</li>
                           <li class="tip">Match the photo of your face and your name above</li>
                         </ul>
                       </div>
                      </li>
                    </ol>
                  </li>

                  <li class="review-task">
                    <h4 class="title">Check Your Contribution Level</h4>

                    <div class="copy">
                      <p>Please confirm your contribution for this course:</p>
                    </div>

                    <ul class="contribution-options">
                      <li class="contribution-option">
                        <input type="radio" id="contribution-25" name="contribution">
                        <label for="contribution-25">
                          <span class="deco-denomination">$</span>
                          <span class="label-value">25</span>
                          <span class="denomination-name">USD</span>
                        </label>
                      </li>
                      <li class="contribution-option">
                        <input type="radio" id="contribution-50" name="contribution">
                        <label for="contribution-50">
                          <span class="deco-denomination">$</span>
                          <span class="label-value">50</span>
                          <span class="denomination-name">USD</span>
                        </label>
                      </li>
                      <li class="contribution-option">
                        <input type="radio" id="contribution-100" name="contribution">
                        <label for="contribution-100">
                          <span class="deco-denomination">$</span>
                          <span class="label-value">100</span>
                          <span class="denomination-name">USD</span>
                        </label>
                      </li>
                      <li class="contribution-option contribution-option-other1">
                        <input type="radio" id="contribution-other" name="contribution">
                        <label for="contribution-other"><span class="sr">Other</span></label>
                      </li>
                      <li class="contribution-option contribution-option-other2">
                        <label for="contribution-other-amt">
                          <span class="sr">Other Amount</span>
                        </label>
                        <div class="wrapper">
                          <span class="deco-denomination">$</span>
                          <input type="text" size="5" name="contribution-other-amt" id="contribution-other-amt" />
                          <span class="denomination-name">USD</span>
                        </div>
                      </li>
                    </ul>
                  </li>
                </ol>
              </div>

              <nav class="nav-wizard">
                <span class="help help-inline">Once you verify your details match the requirements, you can move on to step 4, payment on our secure server.</span>

                <ol class="wizard-steps">
                  <li class="wizard-step">
                    <form id="pay_form" method="post" action="${purchase_endpoint}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">
                      <input type="hidden" name="course_id" value="${course_id | h}" />

                      <ul class="list-fields">
                        <li class="field field-match">
                          <input type="checkbox" name="match" id="confirm_pics_good" />
                          <label for="match">Yes! My details all match.</label>
                        </li>
                      </ul>

                      <input type="button" id="pay_button" value="Go to Step 4: Secure Payment" name="payment">
                    </form>
                  </li>
                </ol>
              </nav>
            </div> <!-- /view -->
          </div> <!-- /wrapper-view -->
        </section>
      </article>
    </div> <!-- /wrapper-content-main -->

    <div class="wrapper-content-supplementary">
      <aside class="content-supplementary">
        <ul class="list-help">
          <li class="help-item">
            <h3 class="title"><i class="icon-question-sign"></i> Have questions?</h3>
            <div class="copy">
              <p>Please read <a rel="external" href="">our FAQs to view common questions about our certificates</a>.</p>
            </div>
          </li>

          <li class="help-item">
            <h3 class="title">Change your mind?</h3>
            <div class="copy">
              <p>You can always <a href="">Audit the course for free</a> without verifying.</p>
            </div>
          </li>
        </ul>
      </aside>
    </div> <!-- /wrapper-content-supplementary -->
  </section>
</div>

<section id="edit-name" class="modal">
<header>
  <h4>${_("Edit Your Full Name")}</h4>
</header>
  <form id="course-checklists" class="course-checklists" method="post" action="">
    <div role="alert" class="status message submission-error" tabindex="-1">
      <p class="message-title">${_("The following error occured while editing your name:")}
        <span class="message-copy"> </span>
      </p>
    </div>
    <p>
      <label for="name">${_('Full Name')}</label>
      <input id="name" type="text" name="name" value="" placeholder="${_('example: Jane Doe')}" required aria-required="true" />
    </p>

    <div class="actions">
      <button class="action action-primary" type="submit">${_("Save")}</button>
      <button class="action action-secondary action-cancel">${_("Cancel")}</button>
    </div>
  </form>
  <a href="#" data-dismiss="modal" rel="view" class="action action-close action-editname-close">
    <i class="icon-remove-sign"></i>
    <span class="label">close</span>
  </a>
</section>
</%block>
