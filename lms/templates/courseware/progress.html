<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%!
from django.utils.translation import ugettext as _
from django.core.urlresolvers import reverse
from util.date_utils import get_time_display, DEFAULT_SHORT_DATE_FORMAT
from django.conf import settings
from django.utils.http import urlquote_plus
%>
<%block name="bodyclass">view-in-course view-progress</%block>

<%block name="headextra">
<%static:css group='style-course-vendor'/>
<%static:css group='style-course'/>
</%block>


<%namespace name="progress_graph" file="/courseware/progress_graph.js"/>

<%block name="pagetitle">${_("{course_number} Progress").format(course_number=course.display_number_with_default) | h}</%block>
<%block name="nav_skip">#course-info-progress</%block>

<%block name="js_extra">
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.js') | h}"></script>
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.stack.js') | h}"></script>
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.symbol.js') | h}"></script>
<script type="text/javascript" src="${static.url('js/courseware/certificates_api.js') | h}"></script>
<script type="text/javascript" src="${static.url('js/courseware/credit_progress.js') | h}"></script>
<script>
  ${progress_graph.body(grade_summary, course.grade_cutoffs, "grade-detail-graph", not course.no_grade, not course.no_grade) | h}
</script>
<script type="text/javascript" charset="utf-8">
$(document).ready(function () {
    var domain_address = document.location.origin
    $(".course-referral-button").click(function () {
        $.post(domain_address + "/api/get_referral_hash_key/", {'course_id': '${str(course.id)}'},
            function (data) {
                $('.course-referral-link').val(domain_address + data.hashkey).show();
                document.execCommand("copy");
            });

    });
});
</script>
</%block>


<%include file="/courseware/course_navigation.html" args="active_page='progress'" />

<style>
#reset_button{
    padding: 5px 0px 8px;
    margin: auto;
    margin-top: 15px;
    background: #1589FF;
    text-align: center;
    color: #FFF;
    border: solid 1px #38ACEC;
    width: 14%;
    box-shadow: inset 0 1px 0 0 #3BB9FF;
    font-weight: bold;
    letter-spacing: 0;
    font: normal 15px/1.6rem "Open Sans",Verdana,Geneva,sans-serif,sans-serif;
    background-clip: padding-box;
    border-radius: 3px;
    box-sizing: border-box;
    cursor:pointer;
    text-shadow: 0 1px 0 #2B65Ec;
}
/*#reset_block{
    padding: 10px;
    border: double 2px #ccc;
    margin-bottom: 30px;
    background: #7DEC56;
}
.reset_msg{
padding: 14px 0px 14px;
    font-weight: normal;
    color: #020201;
    font-size: 14px;
    font-family: calibri;
    text-align: center;
}
.problems_answered_msg{
padding: 14px 0px 14px;
    font-weight: normal;
    color: #020201;
    font-size: 20px;
    font-family: calibri;
    text-align: center;
}
.problems_answered_msg1{
padding: 14px 0px 14px;
    font-weight: normal;
    color: #020201;
    font-size: 20px;
    font-family: calibri;
    text-align: center;
}*/
.icon-info{
    padding: 2px 15px;
    background: linear-gradient(to bottom, rgba(135,188,234,1) 0%,rgba(115,177,231,1) 24%,rgba(10,119,213,1) 50%,rgba(83,159,225,1) 79%,rgba(135,188,234,1) 100%);
    border-radius: 6px;
    color: white;
    font-weight: bold;
    font-size: 23px;
    font-family: segoe ui;
    text-shadow: 1px 1px #777;
    box-shadow: 0px 0px 1px 2px rgba(208,228,247,1);
    margin-right: 10px;
}
.icon-error{
    padding: 0px 11px 6px 12px;
    border-radius: 22px;
    color: white;
    font-size: 22px;
    background: linear-gradient(to bottom, rgba(169,3,41,1) 0%,rgba(143,2,34,1) 44%,rgba(109,0,25,1) 100%);
    box-shadow: 0px 0px 1px 2px #aaa;
    font-family: calibri;
    font-weight: bold;
}
.progress-info-block{
    padding: 25px;
    margin-bottom: 14px;
    font-family: segoe UI;
    background: #eee;
    border: solid 1px #ccc;
}
.warning{
    background: #eaeabe;
    border: dotted 1px yellow;
}
.error{
    background: #f9f2f2;
    border: solid 1px #efe7e7;
}
.progress-info-block .text-block{
    margin-left: 50px;
    margin-top: -20px;
}
</style>

<div class="container">
  <div class="profile-wrapper">

    <div class="course-info" id="course-info-progress" aria-label="${_('Course Progress')}">
      % if not passed:
        % if answered == 0 and reset is None:
<div class="progress-info-block">
	<span class='icon-info'>i</span>
	<div class="text-block">Your progress will be depicted in the graph once you start taking tests.</div>
</div>
        % elif answered == 0 and reset is not None :
<div class="progress-info-block">
        <span class='icon-info'>i</span>
        <div class="text-block">The course has been reset successfully. Please take the course again, to get the fresh scores.</div>
</div>
        % elif answered < count:
<div class="progress-info-block warning">
	<span class='icon-info'>i</span>
	<div class="text-block">You do not have sufficient scores to request for credit yet, you need to answer all questions. (Attempted : ${answered} of ${count})</div>
</div>
        % else:
<div class="progress-info-block" id="reset_course_msg" style="display:none">
        <span class='icon-info'>i</span>
        <div class="text-block">The course has been reset successfully</div>
</div>
<div class="progress-info-block error">
    <span class='icon-error'>x</span>
    <div class="text-block">Unfotunately, you could not obtain sufficient scores to get credit. Please click the button below to reset your course and take it again. Sectionwise scores below can help you decide which sections you may need to have another look at.</div>
    	 <div id="reset_button">Reset my Course</div>
    </div>
<script type="text/javascript">
$("#reset_button").click(function(){
        $.ajax({
                url: "/change_enrollment",
                type: "POST",
                data: {
                        "enrollment_action":"reset",
                        "course_id":"${course.id}"
                },
                success: function(result){
                        $("#reset_button").hide();
			$("#reset_block").hide();
			$("#reset_msg").hide();
			$(".progress-info-block").hide();
                        $("#reset_course_msg").show();
                },
                error: function(result){
			if(result.responseText == "/dashboard"){
	                        $("#reset_button").hide();
				$("#reset_block").hide();
				$("#reset_msg").hide();
	                        $(".progress-info-block").hide();
	                        $("#reset_course_msg").show();
			}
                }
        });
});
</script>

        % endif
      % endif
        <div class="course-referral">
            <button class="course-referral-button">Are you finding this course useful? Refer it to a friend and earn appliedx enlightenment points! Click the button below to generate a URL to send a friend – you’ll get points when they enroll in the course.</button>
            <input class="course-referral-link" type="text" size="70" disabled>
        </div>
      % if staff_access and studio_url is not None:
        <div class="wrap-instructor-info">
          <a class="instructor-info-action studio-view" href="${studio_url | h}">${_("View Grading in studio")}</a>
        </div>
      % endif

      <header class="progress-certificates" cid='${ _("http://agu.mis.amat.com/integ/finish.php?C={course_id}").format(course_id=course.id)}'>
        <h1 class="progress-certificates-title">${_("Course Progress for Student '{username}' ({email})").format(username=student.username, email=student.email) | h}</h1>
      </header>

      %if show_generate_cert_btn | True:
      <div class="wrapper-auto-cert">
        <div id="errors-info" class="errors-info"></div>
        %if passed:
        <div id="course-success" style="padding-top:20px;"><!--removed class auto-cert-message -->
          <%
            SUCCESS_BUTTON_URL = _("http://agu.mis.amat.com/integ/finish.php?C={course_id}").format(course_id=course.id)
            REDIRECT_URL = _("/agu_redirect?custom_credit_url={url}").format(url=course.cert_name_long)
          %>
            <a href="#" data-curl="${SUCCESS_BUTTON_URL}" target="_blank" id="credit_button" style="display:none">
              ${_("Get credit for the course")}
            </a>

<script type="text/javascript">
        $(document).ready(function(){
		var course_id = "${course.id}";
		$.ajax({
                        url: "/last_credit_request?course_id=${course.id}",
                        success: function(result){
				if(result != null) $("#course-success").prepend("<div>You have requested credit for taking the course on " + result.responseText + ". To reinitiate credit request, please click <a onclick='javascript:window.open($(\"#credit_button\").attr(\"href\"))'>here</a></div>")
				else{
				 	$("#credit_button").show();
					//$("#credit_button").click();
					InitiateAutoCompletion();
				}
                	},
                        error: function(result){
                                if(result != null) $("#course-success").prepend("<div>You have requested credit for taking the course on " + result.responseText + ". To reinitiate credit request, please click <a onclick='javascript:window.open($(\"#credit_button\").attr(\"href\"))'>here</a></div>")
                                else{
					$("#credit_button").show();
					InitiateAutoCompletion();
                                        //$("#credit_button").click();
				}
                        }
                });
		//$("#credit_button").click(function(){
		InitiateAutoCompletion = function() {
        	        $.ajax({
	                        url: "/credit_requested?course_id=${course.id}",
                	        success: function(result){
					document.location.href = $('#credit_button').attr("href");
	                        },
        	                error: function(result){
					document.location.href = $('#credit_button').attr("href");
	                        }
        	        });
		}
		//});
	});
	var creditURL = "${course.cert_name_long}";
	var split = creditURL.split("C=");
	courseID = split[1];
	var getCurrentUserEmail = function(){
		return "${student.email}";
	}

	var encryptToSequence = function(courseID){
		var email = getCurrentUserEmail();
		var len = courseID.length;
		var creditKey = [];
		for(var index=0; index<len; index++){
			var keyIndex = index % len;
			creditKey.push(courseID.charCodeAt(index) ^ email.charCodeAt(keyIndex));
		}
		return creditKey.join("-")
	}

	var decryptToSequence = function (creditKeySequence){
		creditKey = creditKeySequence.split("-");
		var email = getCurrentUserEmail();
		var len = creditKey.length;
		var courseID= "";
		for(var index=0; index<len; index++){
			var keyIndex = index % len;
			courseID +=  String.fromCharCode(creditKey[index] ^ email.charCodeAt(keyIndex));
		}
		return courseID;
	}
        $("#credit_button").attr("href", split[0] + "C=" + encryptToSequence(courseID) + "&src=appliedx");
</script>
          <!--div class="has-actions">
              <% post_url = reverse('generate_user_cert', args=[unicode(course.id)]) %>
              % if is_downloadable:
              <div class="msg-content">
                <h2 class="title">${_("Your certificate is available")}</h2>
                <p class="copy">
                  ${_("You can keep working for a higher grade, or request your certificate now.")}
                </p>
              </div>
              <div class="msg-actions">
                %if show_cert_web_view and cert_web_view_url:
                <a class="btn" href="${cert_web_view_url}" target="_blank" title="${_('View certificate in a new browser window or tab.')}">
                  ${_("View Certificate")}
                </a>
                %elif download_url:
                <a class="btn" href="${download_url}" target="_blank" title="${_('PDF will open in a new browser window or tab.')}">
                  ${_("Download Your Certificate")}
                </a>
                %endif
              </div>
              %elif is_generating:
              <div class="msg-content">
                # Translators: This message appears to users when the system is processessing course certificates, which can take a few hours.
                <h2 class="title">${_("We're working on it...")}</h2>
                <p class="copy">${_("We're creating your certificate. You can keep working in your courses and a link to it will appear here and on your Dashboard when it is ready.")}</p>
              </div>
              <div class="msg-actions"></div>
              %else:
              <div class="msg-content">
                <h2 class="title">${_("Congratulations, you qualified for a certificate!")}</h2>
                <p class="copy">${_("You can keep working for a higher grade, or request your certificate now.")}</p>
              </div>
              <div class="msg-actions">
                <button class="btn generate_certs" data-endpoint="${post_url}" id="btn_generate_cert">${_('Request Certificate')}</button>
              </div>
              %endif
          </div-->
        </div>
        %endif
      </div>
      %endif

      %if not course.disable_progress_graph:
        <div class="grade-detail-graph" id="grade-detail-graph" aria-hidden="true"></div>
      %endif

      % if credit_course_requirements:
        <section class="credit-eligibility">
            <div class="credit-eligibility-container">
                <div class="eligibility-heading">
                    <h2>${_("Requirements for Course Credit")}</h2>
                </div>
                %if credit_course_requirements['eligibility_status'] == 'not_eligible':
                    <span class="eligibility_msg">${_("{student_name}, you are no longer eligible for credit in this course.").format(student_name=student.profile.name) | h}</span>
                %elif credit_course_requirements['eligibility_status'] == 'eligible':
                    <span class="eligibility_msg">${_("{student_name}, you have met the requirements for credit in this course.").format(student_name=student.profile.name) | h}
                        ${_("{a_start}Go to your dashboard{a_end} to purchase course credit.").format(
		             a_start=u"<a href={url}>".format(url=reverse('dashboard')),
			     a_end="</a>"
		      )}
                    </span>
                %elif credit_course_requirements['eligibility_status'] == 'partial_eligible':
                    <span>${_("{student_name}, you have not yet met the requirements for credit.").format(student_name=student.profile.name) | h}</span>
                %endif
                <a href="${settings.CREDIT_HELP_LINK_URL | h}" class="credit-help"><i class="fa fa-question"></i><span class="sr">${_("Information about course credit requirements")}</span></a><br>
                <div class="requirement-container" data-eligible="${credit_course_requirements['eligibility_status'] | h}">
                %for requirement in credit_course_requirements['requirements']:
                    <div class="requirement">
                        <div class="requirement-name">
                            ${_(requirement['display_name']) | h}
                            %if requirement['namespace'] == 'grade':
                                <span>${int(requirement['criteria']['min_grade'] * 100) | h}%</span>
                            %endif
                        </div>
                        <div class="requirement-status">
                            %if requirement['status']:
                                %if requirement['status'] == 'submitted':
                                    <span class="requirement-submitted">${_("Verification Submitted")}</span>
                                %elif requirement['status'] == 'failed':
                                    <i class="fa fa-times" aria-hidden="true"></i>
                                    <span>${_("Verification Failed" )}</span>
                                %elif requirement['status'] == 'declined':
                                    <i class="fa fa-times" aria-hidden="true"></i>
                                    <span>${_("Verification Declined" )}</span>
                                %elif requirement['status'] == 'satisfied':
                                    <i class="fa fa-check" aria-hidden="true"></i>
                                    % if requirement['namespace'] == 'grade' and 'final_grade' in requirement['reason']:
                                    <span>${int(requirement['reason']['final_grade'] * 100) | h}%</span>
                                    % else:
                                    <span>${_("Completed")} ${get_time_display(requirement['status_date'], DEFAULT_SHORT_DATE_FORMAT, settings.TIME_ZONE)}</span>
                                    % endif
                                %endif
                            %else:
                                <span class="not-achieve">${_("Upcoming")}</span>
                            %endif
                        </div>
                    </div>
                %endfor
                 </div>
                <button class="detail-collapse" aria-live="polite"><i class="fa fa-caret-up" aria-hidden="true"></i>
                    <span class="requirement-detail">${_("Less")}</span>
                </button>
            </div>
        </section>
      %endif

      <div class="chapters">
        %for chapter in courseware_summary:
        %if not chapter['display_name'] == "hidden":
        <section>
          <h2>${ chapter['display_name'] | h}</h2>

          <div class="sections">
            %for section in chapter['sections']:
            <div>
              <%
              earned = section['section_total'].earned
              total = section['section_total'].possible
              percentageString = "{0:.0%}".format( float(earned)/total) if earned > 0 and total > 0 else ""
              %>

              <h3><a href="${reverse('courseware_section', kwargs=dict(course_id=course.id.to_deprecated_string(), chapter=chapter['url_name'], section=section['url_name'])) | h}">
                ${ section['display_name'] | h}
                %if total > 0 or earned > 0:
                  <span class="sr">
                    ${_("{earned} of {total} possible points").format(earned='{:.3n}'.format(float(earned)), total='{:.3n}'.format(float(total))) | h}
                  </span>
                %endif
                </a>
                %if total > 0 or earned > 0:
                  <span> ${"({0:.3n}/{1:.3n}) {2}".format( float(earned), float(total), percentageString ) | h}</span>
                %endif
              </h3>
              <p>
                ${section['format'] | h}

                %if section.get('due') is not None:
                  <%
                      formatted_string = get_time_display(section['due'], course.due_date_display_format, coerce_tz=settings.TIME_ZONE_DISPLAYED_FOR_DEADLINES)
                      due_date = '' if len(formatted_string)==0 else _(u'due {date}').format(date=formatted_string)
                  %>
                  <em>
                  ${due_date | h}
                  </em>
                %endif
              </p>
	        <% index = 0 %>
              <div class="scores">
                %if len(section['scores']) > 0:
                  <h3> ${ _("Problem Scores: ") if section['graded'] else _("Practice Scores: ")} </h3>
                  <ol>
                    %for score in section['scores']:
		      %if section['attempts'][index] and len(section['attempts'])>0:
                        <li><strong>${"{0:.3n}/{1:.3n}".format(float(score.earned),float(score.possible)) | h}</strong></li>
                      %else :
                        <li style="display:none">${"{0:.3n}/{1:.3n}".format(float(score.earned),float(score.possible)) | h}</li>
                        <li>${"0/{0:.3n}".format(float(score.possible)) | h}</li>
                      %endif
			<% index+=1 %>
                    %endfor
                  </ol>
                %else:
                  <h3 class="no-scores"> ${_("No problem scores in this section")} </h3>
                %endif
              </div>


            </div> <!--End section-->
            %endfor
          </div> <!--End sections-->
        </section> <!--End chapter-->
        %endif
        %endfor
      </div> <!--End chapters-->

    </div>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
	setTimeout(function(){
		var index = 0;
                $(".scores h3").each(function(){
                        if(!$(this).hasClass("no-scores")){
                                $(this).html("<div>Problem Scores for <span class='qname'>" + $(".tickLabel")[index].innerHTML+ "</span>");
                                index++;
                        }
                });
	}, 2000);
});
</script>
